pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  environment {
    COMPOSE_FILE = "devops-final-project/docker-compose.yml"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build') {
      steps {
        sh 'docker compose -f $COMPOSE_FILE build app'
      }
    }

    stage('Deploy') {
      steps {
        sh 'docker compose -f $COMPOSE_FILE up -d --remove-orphans app'
      }
    }

    stage('Smoke Test') {
  steps {
    sh 'sleep 3'
    sh 'docker compose -f $COMPOSE_FILE ps'
    sh 'docker compose -f $COMPOSE_FILE exec -T app node -e "fetch(\'http://localhost:3000/health\').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))"'
  }
}
