pipeline {
  agent any

  environment {
    APP_NAME = "phase3-mini-app"
    IMAGE_NAME = "phase3-mini-app:latest"
    HOST_PORT = "80"
    CONTAINER_PORT = "3000"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          cd 03-phase3-cicd-monitoring-mini/app
          docker build -t ${IMAGE_NAME} .
        '''
      }
    }

    stage('Deploy Container') {
      steps {
        sh '''
          set +e
          docker stop ${APP_NAME}
          docker rm ${APP_NAME}
          set -e

          docker run -d \
            --name ${APP_NAME} \
            --restart unless-stopped \
            -p ${HOST_PORT}:${CONTAINER_PORT} \
            ${IMAGE_NAME}
        '''
      }
    }

    stage('Verify') {
      steps {
        sh '''
          sleep 3
          curl -sS http://localhost/health
        '''
      }
    }
  }
}
